# PMY - Title IX Consent Documentation App

## Overview
PMY is a mobile-first web application for documenting consent in compliance with Title IX regulations. It offers multiple consent capture methods (digital signatures, audio, photo, biometrics) and provides educational resources on Title IX and state consent laws, tailored to specific universities. PMY aims to be a secure, legally compliant, and leading solution for Title IX compliance and education in academic institutions.

## User Preferences
Preferred communication style: Simple, everyday language.

## System Architecture

### UI/UX Decisions
The application adheres to Apple Human Interface Guidelines, featuring a mobile-first, fully responsive design with light/dark mode. It utilizes a system font stack, clear heading hierarchy, and Tailwind CSS with custom design tokens. Core UI components include a bottom navigation bar, card-based layouts, inline confirmations, and iOS-standard toast notifications. The primary action, consent creation, is immediately accessible. Color usage follows a semantic system for consistent visual language and automatic dark mode support.

### Technical Implementations
The frontend uses React 18, TypeScript, Vite, Wouter for routing, TanStack Query for state management, and `shadcn/ui` (Radix UI) with Tailwind CSS. Form validation is handled by `react-hook-form` and `zod`. The backend is built with Express.js, Node.js, and TypeScript, offering RESTful APIs and Multer for file uploads. Drizzle ORM manages type-safe PostgreSQL interactions with Neon serverless. Supabase Auth handles authentication with PKCE flow, providing user sessions and JWTs for secure API access.

The backend implements modular Express Router architecture with domain-based separation into 8 specialized routers: notifications (4 endpoints), recordings (3 endpoints), amendments (4 endpoints), universities (2 endpoints), state-laws (2 endpoints), auth (6 endpoints), profile (8 endpoints), and contracts (23 endpoints). All routers are mounted at `/api` with relative paths.

### Feature Specifications
- **Consent Documentation**: Supports digital signature, audio recording, photo/selfie capture, and biometric authentication. The flow adjusts dynamically based on encounter type, includes a three-state intimate acts selection, and optional contract duration. Users can save drafts at any point after Step 1.
- **Title IX Information**: Provides university-specific educational content and policy summaries generated by OpenAI GPT-4o-mini.
- **State Consent Laws**: Comprehensive database of consent laws for all 50 U.S. states, including age of consent, Romeo and Juliet laws, affirmative consent requirements, and reporting requirements.
- **Tools**: Quick access panel for Title IX policies, state consent laws, ID verification, and consent documentation status checks.
- **Integrations Settings**: Manages third-party ID and age verification services.
- **User Management**: Secure authentication, account management (email changes, data retention, deletion).
- **Billing & Payment Methods**: Manages PCI-compliant payment methods via Stripe.
- **University Data**: Pre-seeded database of US universities and their Title IX information.
- **Paid Verification**: Allows users to pay for advanced AI models (GPT-4, GPT-4o) to verify university Title IX policies.
- **Sharing & Referrals**: Features a Dropbox-style referral program (Resend API) and allows sharing of consent documents via email, including an Instagram-inspired QR code sharing screen. All emails sent to external participants include prominent "Join PMY" invite sections with benefits-driven messaging to encourage account creation.
- **Instagram-Style Profile**: Displays user avatar, name, stats (total/active contracts, recordings), bio, and website URL, with tab navigation for contracts and recordings.
- **User Preferences**: Allows setting default values for consent flows (university, state, encounter type, duration).
- **Account Verification**: Users can verify identity for a one-time $5 fee using Stripe Identity, receiving a verified badge. A 48-hour cooldown is enforced after failed attempts.
- **Async Collaborative Contracts**: Enables co-creation of consent documentation through invitation-based sharing and mutual approval workflows with robust storage and validation. Includes "Save as Draft" and "Share" options.
- **Contract Amendment System**: Allows participants to request, approve, or reject modifications to active contracts (e.g., adding/removing intimate acts, changing duration). Amendments require approval from all participants.
- **Notification System**: In-app and email (via Resend API) notifications for contract-related events, such as amendment requests, approvals, and rejections. Notifications are polled and can be marked as read. Email notifications are opt-out.
- **Dual-Mode Participant Support**: Supports both PMY users (@username with full digital features) and external participants (legal names only, no digital interaction). External participants are stored for documentation purposes but cannot receive notifications or digital verification. All emails to external participants include prominent "Join PMY" invite CTAs to encourage account creation and full platform access.

### System Design Choices
- **Database Schema**: Includes tables for `universities`, `state_laws`, `consentRecordings`, `consentContracts`, `user_profiles`, `payment_methods`, `contract_collaborators`, `contract_invitations`, `account_verifications`, `contract_amendments`, and `notifications`. The `consentContracts` table includes collaboration fields and a lifecycle (`draft`, `pending_approval`, `active`, `paused`, `completed`, `rejected`). The `user_profiles` table includes `emailNotificationsEnabled` (default 'true', opt-out design) for controlling email delivery. The `contract_amendments` table stores amendment requests with type, description, newValue (JSONB), and status fields. The `notifications` table tracks user notifications with userId, type, title, message, isRead status, and relatedContractId/relatedAmendmentId references.
- **API Design**: RESTful APIs support CRUD operations and multipart form data.
- **Modular Routing Architecture**: Backend uses Express Router pattern with domain-based separation. All core domains extracted to dedicated router files: `notifications` (4 endpoints), `recordings` (3 endpoints), `amendments` (4 endpoints), `universities` (2 endpoints), `state-laws` (2 endpoints), `auth` (6 endpoints), `profile` (8 endpoints), and `contracts` (23 endpoints). Shared cross-cutting logic resides in `server/routes/helpers/`. This modular structure reduced `routes.ts` from 3,051 to 996 lines (67% total reduction) while improving maintainability, testability, and developer navigation. All routers are registered centrally in `routes.ts`: most use domain-specific namespaces (e.g., `/api/amendments`, `/api/notifications`), while contracts router uses `/api` with relative paths for clean URL resolution.
- **State Management**: Frontend uses TanStack Query for server state and React Context API with cross-platform storage abstraction for consent flow state.
- **iOS-Ready Secure Storage**: Implements AES-256 encrypted Keychain storage on iOS (and Keystore on Android) with fallback to `sessionStorage`.
- **Navigation**: Bottom navigation bar with "Create", "Tools", "Contracts", and "Profile" tabs. The Contracts tab includes sections for Active, Paused, and Completed contracts, with additional Drafts and Inbox tabs for collaborative features.
- **Contract Lifecycle & Modification**: Active contracts can be paused and resumed. Completed contracts are immutable to ensure legal accountability.
- **Security**: Production-grade security (~94% coverage, ~86% OWASP compliance) includes `requireAuth` middleware, user data isolation, ownership verification, Supabase Auth password hashing, server-side validation, WebAuthn, encrypted native storage, comprehensive rate limiting (5 tiers), and CORS protection with environment-driven whitelisting. Security operations documented in `SECURITY_OPERATIONS.md`. OWASP Top 10 (2021) compliance documented in `OWASP_COMPLIANCE.md`.
- **Testing**: Comprehensive testing strategy includes:
  - **Bart Simpson (@bart)** - PMY's official demo user and distinguished first user
    - **Real Account**: Email `bart.simpson@pmy.demo`, Password `BartPlaysNBA2024!`
    - **Profile**: NBA player based in California with comprehensive test data
    - **Test Data**: Active/paused/completed contracts, voice recordings, saved contacts
    - **Setup Script**: `npx tsx scripts/setup-bart.ts` recreates Bart's account
  - **Bart API Testing (bart.ts)** - Comprehensive backend testing powered by @bart's perspective
    - High-net-worth professional whose career depends on PMY working flawlessly
    - Tests 54 endpoints across all 8 domain routers with AI-powered failure analysis (OpenAI GPT-4o-mini)
    - Achieves 100% pass rate (54/54 tests) validating all authentication middleware and routing
    - Demands absolute reliability, legal compliance, and professional polish
    - We regularly consult with Bart for feedback on features and UX decisions
    - Run with: `npx tsx bart.ts`
    - See `BART_README.md` and `BART_QUICK_START.md` for technical details
  - **Bart E2E Browser Testing (bart-e2e.ts)** - Independent end-to-end Playwright testing
    - Complete user flow validation: login, contract creation (6 steps), verification
    - Real Supabase authentication using @bart's credentials
    - 100% pass rate (3/3 tests) validating complete UX flows
    - Bypasses Replit agent testing limitations and Stripe requirements
    - Run headless: `npx tsx bart-e2e.ts --headless`
    - Run headed (debug): `npx tsx bart-e2e.ts --headed`
    - System dependencies: Chromium, X11 libraries (xorg.libxcb, xorg.libX11, mesa)
- **Feature Flags**: Environment variable-controlled feature flag system (`VITE_ENABLE_COLLABORATIVE_CONTRACTS`) for experimental and beta features.

## External Dependencies

- **Database**: PostgreSQL (via `@neondatabase/serverless`), Drizzle ORM
- **Frontend Frameworks/Libraries**: React, Wouter, TanStack Query, React Hook Form, Zod, React Signature Canvas
- **UI Libraries**: Radix UI (via `shadcn/ui`), Tailwind CSS
- **Backend Frameworks/Libraries**: Express, Multer, SimpleWebAuthn, WS, Express Rate Limit
- **iOS/Native Integration**: Capacitor, Capacitor Secure Storage Plugin
- **AI Services**: OpenAI API (GPT-4o-mini, GPT-4, GPT-4o)
- **Payment Processing**: Stripe (for paid verification features, not core consent flow)
- **Email Services**: Resend API
- **Authentication**: Supabase (Client, SSR), SimpleWebAuthn (Browser)

---

## Documentation Index

### Developer Documentation
- **`SECURITY_GUIDELINES.md`** - Security implementation patterns and required code practices for developers
- **`design_guidelines.md`** - UI/UX design system, component patterns, and Apple HIG compliance
- **`test-strategy.md`** - Comprehensive testing strategy including Bart API tests and Playwright E2E tests

### Security & Compliance
- **`SECURITY_OPERATIONS.md`** - Production deployment checklist, CORS configuration, rate limiting reference, incident response
- **`OWASP_COMPLIANCE.md`** - Full OWASP Top 10 (2021) compliance assessment with scoring, evidence, and recommendations (~86% compliance)

### Testing
- **`BART_README.md`** - Complete documentation of Bart, PMY's 54-endpoint API testing agent and distinguished first user
- **`BART_QUICK_START.md`** - Quick reference for running Bart tests
- **`BART_SETUP.md`** - Bart's account setup, test data, and demo user configuration
- **`STATE_SELECTION_TESTS.md`** - Test plan for state selection feature in consent flow

### iOS Deployment
- **`IOS_DEPLOYMENT_STRATEGY.md`** - Two-phase iOS deployment strategy (Capacitor WebView + React Native enhancement)
- **`ios-permissions.md`** - Required Info.plist permissions for camera, microphone, Face ID, photo library
- **`ios-app-icons.md`** - App icon and splash screen requirements for App Store submission

### Scripts
- **`scripts/setup-bart.ts`** - Creates Bart's demo account with test data
- **`bart.ts`** - Runs comprehensive 54-endpoint API test battery
- **`bart-e2e.ts`** - Runs independent E2E browser tests (login, contract flow, verification)
- **`test-cors.ts`** - Validates CORS security configuration