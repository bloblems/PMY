# PMY - Title IX Consent Documentation App

## Overview
PMY is a mobile-first web application for documenting consent in compliance with Title IX regulations. It offers multiple consent capture methods (digital signatures, audio, photo, biometrics) and provides educational resources on Title IX and state consent laws, tailored to specific universities. PMY aims to be a secure, legally compliant, and leading solution for Title IX compliance and education in academic institutions.

## User Preferences
Preferred communication style: Simple, everyday language.

## System Architecture

### UI/UX Decisions
The application adheres to Apple Human Interface Guidelines, featuring a mobile-first, fully responsive design with light/dark mode. It utilizes a system font stack, clear heading hierarchy, and Tailwind CSS with custom design tokens. Core UI components include a bottom navigation bar, card-based layouts, inline confirmations, and iOS-standard toast notifications. The primary action, consent creation, is immediately accessible. Color usage follows a semantic system for consistent visual language and automatic dark mode support.

### Technical Implementations
The frontend uses React 18, TypeScript, Vite, Wouter for routing, TanStack Query for state management, and `shadcn/ui` (Radix UI) with Tailwind CSS. Form validation is handled by `react-hook-form` and `zod`. The backend is built with Express.js, Node.js, and TypeScript, offering RESTful APIs and Multer for file uploads. Drizzle ORM manages type-safe PostgreSQL interactions with Neon serverless. Supabase Auth handles authentication with PKCE flow, providing user sessions and JWTs for secure API access.

### Feature Specifications
- **Consent Documentation**: Supports digital signature, audio recording, photo/selfie capture, and biometric authentication. The flow adjusts dynamically based on encounter type, includes a three-state intimate acts selection, and optional contract duration. Users can save drafts at any point after Step 1.
- **Title IX Information**: Provides university-specific educational content and policy summaries generated by OpenAI GPT-4o-mini.
- **State Consent Laws**: Comprehensive database of consent laws for all 50 U.S. states, including age of consent, Romeo and Juliet laws, affirmative consent requirements, and reporting requirements.
- **Tools**: Quick access panel for Title IX policies, state consent laws, ID verification, and consent documentation status checks.
- **Integrations Settings**: Manages third-party ID and age verification services.
- **User Management**: Secure authentication, account management (email changes, data retention, deletion).
- **Billing & Payment Methods**: Manages PCI-compliant payment methods via Stripe.
- **University Data**: Pre-seeded database of US universities and their Title IX information.
- **Paid Verification**: Allows users to pay for advanced AI models (GPT-4, GPT-4o) to verify university Title IX policies.
- **Sharing & Referrals**: Features a Dropbox-style referral program (Resend API) and allows sharing of consent documents via email, including an Instagram-inspired QR code sharing screen.
- **Instagram-Style Profile**: Displays user avatar, name, stats (total/active contracts, recordings), bio, and website URL, with tab navigation for contracts and recordings.
- **User Preferences**: Allows setting default values for consent flows (university, state, encounter type, duration).
- **Account Verification**: Users can verify identity for a one-time $5 fee using Stripe Identity, receiving a verified badge. A 48-hour cooldown is enforced after failed attempts.
- **Async Collaborative Contracts**: Enables co-creation of consent documentation through invitation-based sharing and mutual approval workflows with robust storage and validation. Includes "Save as Draft" and "Share" options.
- **Contract Amendment System**: Allows participants to request, approve, or reject modifications to active contracts (e.g., adding/removing intimate acts, changing duration). Amendments require approval from all participants.
- **Notification System**: In-app and email (via Resend API) notifications for contract-related events, such as amendment requests, approvals, and rejections. Notifications are polled and can be marked as read. Email notifications are opt-out.

### System Design Choices
- **Database Schema**: Includes tables for `universities`, `state_laws`, `consentRecordings`, `consentContracts`, `user_profiles`, `payment_methods`, `contract_collaborators`, `contract_invitations`, `account_verifications`, `contract_amendments`, and `notifications`. The `consentContracts` table includes collaboration fields and a lifecycle (`draft`, `pending_approval`, `active`, `paused`, `completed`, `rejected`). The `user_profiles` table includes `emailNotificationsEnabled` (default 'true', opt-out design) for controlling email delivery. The `contract_amendments` table stores amendment requests with type, description, newValue (JSONB), and status fields. The `notifications` table tracks user notifications with userId, type, title, message, isRead status, and relatedContractId/relatedAmendmentId references.
- **API Design**: RESTful APIs support CRUD operations and multipart form data.
- **State Management**: Frontend uses TanStack Query for server state and React Context API with cross-platform storage abstraction for consent flow state.
- **iOS-Ready Secure Storage**: Implements AES-256 encrypted Keychain storage on iOS (and Keystore on Android) with fallback to `sessionStorage`.
- **Navigation**: Bottom navigation bar with "Create", "Tools", "Contracts", and "Profile" tabs. The Contracts tab includes sections for Active, Paused, and Completed contracts, with additional Drafts and Inbox tabs for collaborative features.
- **Contract Lifecycle & Modification**: Active contracts can be paused and resumed. Completed contracts are immutable to ensure legal accountability.
- **Security**: Comprehensive measures include `requireAuth` middleware, user data isolation, ownership verification, Supabase Auth password hashing, server-side validation, WebAuthn, encrypted native storage, and rate limiting.
- **Testing**: Automated test strategy using Playwright for E2E tests, covering security, core functionality, integration, and polish.
- **Feature Flags**: Environment variable-controlled feature flag system (`VITE_ENABLE_COLLABORATIVE_CONTRACTS`) for experimental and beta features.

## External Dependencies

- **Database**: PostgreSQL (via `@neondatabase/serverless`), Drizzle ORM
- **Frontend Frameworks/Libraries**: React, Wouter, TanStack Query, React Hook Form, Zod, React Signature Canvas
- **UI Libraries**: Radix UI (via `shadcn/ui`), Tailwind CSS
- **Backend Frameworks/Libraries**: Express, Multer, SimpleWebAuthn, WS, Express Rate Limit
- **iOS/Native Integration**: Capacitor, Capacitor Secure Storage Plugin
- **AI Services**: OpenAI API (GPT-4o-mini, GPT-4, GPT-4o)
- **Payment Processing**: Stripe (for paid verification features, not core consent flow)
- **Email Services**: Resend API
- **Authentication**: Supabase (Client, SSR), SimpleWebAuthn (Browser)